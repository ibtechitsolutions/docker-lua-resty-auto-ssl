server {
  set_by_lua $PROXY_COUCHDB 'return os.getenv("PROXY_COUCHDB")';

  listen 5984;

  location / {
    proxy_pass http://$PROXY_COUCHDB/;
    proxy_set_header Host $host:$server_port;
    expires -1;
    add_header Pragma no-cache;
    add_header Cache-Control "no-store";
  }
}

server {
  set_by_lua $REMOTE_HOST 'return os.getenv("REMOTE_HOST")';
  set_by_lua $PROXY_COUCHDB 'return os.getenv("PROXY_COUCHDB")';

  listen 5984 ssl;
  server_name $REMOTE_HOST;

  ssl_certificate_by_lua_block {
    auto_ssl:ssl_certificate()
  }

  ssl_certificate /etc/ssl/resty-auto-ssl-fallback.crt;
  ssl_certificate_key /etc/ssl/resty-auto-ssl-fallback.key;

  location / {
    proxy_pass http://$PROXY_COUCHDB/;
    proxy_set_header Host $host:$server_port;
    expires -1;
    add_header Pragma no-cache;
    add_header Cache-Control "no-store";
  }
}
